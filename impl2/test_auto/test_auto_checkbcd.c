#include <stdlib.h>
#include <stdio.h>
#include <string.h>

#include "dcf77_bitlayer.h"
#include "dcf77_secondlayer.h"
#include "dcf77_secondlayer_check_bcd_correct_telegram.h"

struct checkbcd_test_case {
	char*         description;
	unsigned char expect_is_valid;
	unsigned char telegram[DCF77_SECONDLAYER_LINE_BYTES];
};

static struct checkbcd_test_case TEST_CASES[] = {

/*
 * Output from another test. This telegram is entirely invalid because
 *  - it has wrong date parity
 *  - 00 for day of month and
 *  - 1101 for month ones
 *  - incorrect end of minute (should be NO_SIGNAL)
 */
{"T1 invalid date parity fails check", 0,
{0x55,0x55,0x55,0x55,0x55,0x55,0xa9,0xaa,0xaa,0xaa,0xea,0xbd,0xab,0xba,0xea,}},
{"T1 unrealistic day of month fails check", 0,
{0xa9,0xaa,0xaa,0x6a,0x55,0x55,0xa9,0xaa,0xaa,0xaa,0xea,0xef,0xaa,0xba,0xfa,}},
{"T1 corrected passes", 1,
{0xa9,0xaa,0xaa,0x6a,0x55,0x55,0xa9,0xaa,0xaa,0xab,0xea,0xef,0xaa,0xba,0x6a,}},

/* T2 series test with one error of each kind. */
{"T2 all correct base input", 1,
{0xee,0xee,0xba,0xbf,0xba,0xaf,0xab,0xae,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E1 missing constant begin of minute 0", 0,
{0xef,0xee,0xba,0xbf,0xba,0xaf,0xab,0xae,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E2 misformatted DST 11", 0,
{0xee,0xee,0xba,0xbf,0xbe,0xaf,0xab,0xae,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E2 misformatted DST 00", 0,
{0xee,0xee,0xba,0xbf,0xaa,0xaf,0xab,0xae,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E3 missing constant begin of time 1", 0,
{0xee,0xee,0xba,0xbf,0xba,0xae,0xab,0xae,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E4 minute ones 11 > 9", 0,
{0xee,0xee,0xba,0xbf,0xae,0xbf,0xab,0xaf,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E5 minute tens 7 > 5", 0,
{0xee,0xee,0xba,0xbf,0xae,0xaf,0xff,0xaf,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E6 minute parity fails", 0,
{0xee,0xee,0xba,0xbf,0xae,0xaf,0xab,0xaf,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E7 hour ones 13 > 9", 0,
{0xee,0xee,0xba,0xbf,0xae,0xaf,0xab,0xee,0xbb,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E8 hour tens 3 > 2", 0,
{0xee,0xee,0xba,0xbf,0xae,0xaf,0xab,0xba,0xfe,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E8b hour tens = 2 and hour ones 4 > 3", 0,
{0xee,0xee,0xba,0xbf,0xae,0xaf,0xab,0xea,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E9 hour parity fails", 0,
{0xee,0xee,0xba,0xbf,0xae,0xaf,0xab,0xea,0xba,0xaf,0xfa,0xaf,0xea,0xbb,0x7a,}},
{"T2 E10 day ones 11 > 9", 0,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xef,0xea,0xee,0xea,0xbb,0x7a,}},
{"T2 E10b day 00 is invalid", 0,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xaa,0xea,0xef,0xea,0xbb,0x7a,}},
{"T2 E11b month 00 is invalid", 0,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xaf,0xaa,0xab,0xea,0xbb,0x6a,}},
{"T2 E11b month 13 is invalid", 0,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xaf,0xea,0xbe,0xee,0xbb,0x7a,}},
{"T2 E12 year ones 14 > 9", 0,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xaf,0xea,0xee,0xea,0xbf,0x7a,}},
{"T2 E13 year tens 11 > 9", 0,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xaf,0xea,0xee,0xea,0xfb,0x6e,}},
{"T2 E14 date parity fails", 0,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xaf,0xea,0xee,0xea,0xbb,0x6e,}},
{"T2 E15 end of minute marker has 0", 0,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xaf,0xea,0xee,0xea,0xbb,0xbe,}},
{"T2 E15 end of minute marker has 1", 0,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xaf,0xea,0xee,0xea,0xbb,0xfe,}},
{"T2 final telegram corrected is valid", 1,
{0xaa,0xaa,0xaa,0xaa,0xae,0xaf,0xab,0xbe,0xfa,0xaf,0xea,0xee,0xea,0xbb,0x7e,}},

};

#define NUM_TEST_CASES (sizeof(TEST_CASES)/sizeof(struct checkbcd_test_case))

int main(int argc, char** argv)
{
	struct dcf77_secondlayer ctx;
	unsigned int i;
	unsigned int j;
	unsigned char test_result;
	unsigned char has_fail = 0;
	memset(&ctx, 0, sizeof(struct dcf77_secondlayer));
	for(i = 0; i < NUM_TEST_CASES; i++) {
		memcpy(ctx.private_telegram_data, TEST_CASES[i].telegram,
						DCF77_SECONDLAYER_LINE_BYTES);
		test_result = dcf77_secondlayer_check_bcd_correct_telegram(&ctx,
									0, 0);
		if(test_result == TEST_CASES[i].expect_is_valid) {
			printf("[ OK ] %s\n", TEST_CASES[i].description);
		} else {
			has_fail = 1;
			printf("[FAIL] %s -- expected %d, got %d for {",
				TEST_CASES[i].description,
				TEST_CASES[i].expect_is_valid, test_result);
			for(j = 0; j < DCF77_SECONDLAYER_LINE_BYTES; j++)
				printf("0x%02x,", TEST_CASES[i].telegram[j]);
			printf("0x00}\n");
		}
	}
	return has_fail? EXIT_FAILURE: EXIT_SUCCESS;
}
