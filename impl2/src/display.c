#include "display_shared.h"
#include "display.h"
#include "ll_out_display.h"

/*
 * Copied from https://github.com/adafruit/
 * Adafruit-Graphic-VFD-Display-Library/blob/master/Adafruit_GP9002.h
 */
#define GP9002_DISPLAYSOFF        0x00
#define GP9002_DISPLAY1ON         0x01
#define GP9002_DISPLAY2ON         0x02
#define GP9002_ADDRINCR           0x04
#define GP9002_ADDRHELD           0x05
#define GP9002_CLEARSCREEN        0x06
#define GP9002_CONTROLPOWER       0x07
#define GP9002_DATAWRITE          0x08
#define GP9002_DATAREAD           0x09
#define GP9002_LOWERADDR1         0x0A
#define GP9002_HIGHERADDR1        0x0B
#define GP9002_LOWERADDR2         0x0C
#define GP9002_HIGHERADDR2        0x0D
#define GP9002_ADDRL              0x0E
#define GP9002_ADDRH              0x0F
#define GP9002_OR                 0x10
#define GP9002_XOR                0x11
#define GP9002_AND                0x12
#define GP9002_BRIGHT             0x13 /* 3-5-10. Luminance Adjustment */
#define GP9002_DISPLAY            0x14
#define GP9002_DISPLAY_MONOCHROME 0x10
#define GP9002_DISPLAY_GRAYSCALE  0x14
#define GP9002_INTMODE            0x15
#define GP9002_DRAWCHAR           0x20
#define GP9002_CHARRAM            0x21
#define GP9002_CHARSIZE           0x22
#define GP9002_CHARBRIGHT         0x24

/* == Terminus Font == */

/* one long unsigned makes one vertical line */
static const long unsigned FONT_LARGE[][16] = {

	/* -- area mapped to ASCII -- */

	/* - */
	{0x0,0x18000,0x18000,0x18000,0x18000,0x18000,0x18000,0x18000,0x18000,0x18000,0x18000,0x18000,0x18000,0x18000,0x0,0x0,},
	/* . */
	{0x0,0x0,0x0,0x0,0x0,0x0,0x3c0,0x3c0,0x3c0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,},
	/* / */
	{0x0,0x0,0xc0,0x3c0,0xfc0,0x3f00,0xfc00,0x3f000,0xfc000,0x3f0000,0xfc0000,0x3f00000,0x3c00000,0x3000000,0x0,0x0,},
	/* 0 */
	{0x0,0xffff00,0x1ffff80,0x3ffffc0,0x38071c0,0x300e0c0,0x301c0c0,0x30380c0,0x30700c0,0x30e00c0,0x39c01c0,0x3ffffc0,0x1ffff80,0xffff00,0x0,0x0,},
	/* 1 */
	{0x0,0x0,0x0,0x6000c0,0xe000c0,0x1e000c0,0x3ffffc0,0x3ffffc0,0x3ffffc0,0xc0,0xc0,0xc0,0x0,0x0,0x0,0x0,},
	/* 2 */
	{0x0,0xf801c0,0x1f803c0,0x3f807c0,0x3800ec0,0x3001cc0,0x30038c0,0x30070c0,0x300e0c0,0x301c0c0,0x38380c0,0x3ff00c0,0x1fe00c0,0xfc00c0,0x0,0x0,},
	/* 3 */
	{0x0,0xe00700,0x1e00780,0x3e007c0,0x38181c0,0x30180c0,0x30180c0,0x30180c0,0x30180c0,0x30180c0,0x383c1c0,0x3ffffc0,0x1ffff80,0xfe7f00,0x0,0x0,},
	/* 4 */
	{0x0,0xf800,0x1f800,0x3f800,0x71800,0xe1800,0x1c1800,0x381800,0x701800,0xe01800,0x1c01800,0x3ffffc0,0x3ffffc0,0x3ffffc0,0x0,0x0,},
	/* 5 */
	{0x0,0x3ff0300,0x3ff0380,0x3ff03c0,0x30301c0,0x30300c0,0x30300c0,0x30300c0,0x30300c0,0x30300c0,0x30380c0,0x303ffc0,0x301ff80,0x300ff00,0x0,0x0,},
	/* 6 */
	{0x0,0xffff00,0x1ffff80,0x3ffffc0,0x38301c0,0x30300c0,0x30300c0,0x30300c0,0x30300c0,0x30300c0,0x30381c0,0x303ffc0,0x301ff80,0xff00,0x0,0x0,},
	/* 7 */
	{0x0,0x3f00000,0x3f00000,0x3f00000,0x3000000,0x3000000,0x3001fc0,0x3007fc0,0x301ffc0,0x307e000,0x31f8000,0x3fe0000,0x3f80000,0x3e00000,0x0,0x0,},
	/* 8 */
	{0x0,0xfe7f00,0x1ffff80,0x3ffffc0,0x383c1c0,0x30180c0,0x30180c0,0x30180c0,0x30180c0,0x30180c0,0x383c1c0,0x3ffffc0,0x1ffff80,0xfe7f00,0x0,0x0,},
	/* 9 */
	{0x0,0xff0000,0x1ff80c0,0x3ffc0c0,0x381c0c0,0x300c0c0,0x300c0c0,0x300c0c0,0x300c0c0,0x300c0c0,0x380c1c0,0x3ffffc0,0x1ffff80,0xffff00,0x0,0x0,},
	/* : */
	{0x0,0x0,0x0,0x0,0x0,0x0,0xf03c0,0xf03c0,0xf03c0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,},

	/* -- spearate mappnig required -- */

	/* ( */
	{0x0,0x0,0x0,0x0,0x1ff800,0x7ffe00,0xffff00,0x1e00780,0x38001c0,0x30000c0,0x2000040,0x0,0x0,0x0,0x0,0x0,},
	/* ! */
	{0x0,0x0,0x0,0x0,0x0,0x0,0x3ffe3c0,0x3ffe3c0,0x3ffe3c0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,},
	/* ) */
	{0x0,0x0,0x0,0x0,0x2000040,0x30000c0,0x38001c0,0x1e00780,0xffff00,0x7ffe00,0x1ff800,0x0,0x0,0x0,0x0,0x0,},
	/* * */
	{0x0,0x18000,0x218400,0x318c00,0x399c00,0x1db800,0xff000,0x7e000,0xff000,0x1db800,0x399c00,0x318c00,0x218400,0x18000,0x0,0x0,},
	/* # */
	{0x0,0x181800,0x181800,0x3ffffc0,0x3ffffc0,0x3ffffc0,0x181800,0x181800,0x181800,0x3ffffc0,0x3ffffc0,0x3ffffc0,0x181800,0x181800,0x0,0x0,},
	/*   */
	{0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,}
};

/* one unsigned makes one vertical line. first char = ... */
static const unsigned FONT_SMALL[][8] = {
	/* ! */ {0x0,0x0,0x0,0x3fb0,0x0,0x0,0x0,0x0,},
	/* " */ {0x0,0x0,0x7000,0x0,0x0,0x7000,0x0,0x0,},
	/* # */ {0x0,0x480,0x3ff0,0x480,0x480,0x3ff0,0x480,0x0,},
	/* \ */ {0xe20,0x1110,0x1110,0x7ffc,0x1110,0x1110,0x8e0,0x0,},
	/* & */ {0x1000,0x2830,0x28c0,0x1320,0xc50,0x3050,0x20,0x0,},
	/* ' */ {0x0,0x1e0,0x1a10,0x2610,0x2510,0x18e0,0x110,0x0,},
	/* ( */ {0x0,0x0,0x0,0x7000,0x0,0x0,0x0,0x0,},
	/* ) */ {0x0,0x0,0xfc0,0x1020,0x2010,0x0,0x0,0x0,},
	/* * */ {0x0,0x0,0x2010,0x1020,0xfc0,0x0,0x0,0x0,},
	/* + */ {0x0,0x100,0x540,0x380,0x380,0x540,0x100,0x0,},
	/* , */ {0x0,0x100,0x100,0x7c0,0x100,0x100,0x0,0x0,},
	/* - */ {0x0,0x0,0x8,0x30,0x0,0x0,0x0,0x0,},
	/* . */ {0x0,0x100,0x100,0x100,0x100,0x100,0x100,0x0,},
	/* / */ {0x0,0x0,0x0,0x30,0x0,0x0,0x0,0x0,},
	/* 0 */ {0x0,0x30,0xc0,0x300,0xc00,0x3000,0x0,0x0,},
	/* 1 */ {0x0,0x1fe0,0x2090,0x2110,0x2210,0x2410,0x1fe0,0x0,},
	/* 2 */ {0x0,0x0,0x810,0x1010,0x3ff0,0x10,0x10,0x0,},
	/* 3 */ {0x0,0x1830,0x2050,0x2090,0x2110,0x2210,0x1c10,0x0,},
	/* 4 */ {0x0,0x1860,0x2010,0x2210,0x2210,0x2210,0x1de0,0x0,},
	/* 5 */ {0x0,0x180,0x280,0x480,0x880,0x1080,0x3ff0,0x0,},
	/* 6 */ {0x0,0x3e20,0x2210,0x2210,0x2210,0x2210,0x21e0,0x0,},
	/* 7 */ {0x0,0xfe0,0x1210,0x2210,0x2210,0x2210,0x1e0,0x0,},
	/* 8 */ {0x0,0x2000,0x2000,0x2070,0x2180,0x2600,0x3800,0x0,},
	/* 9 */ {0x0,0x1de0,0x2210,0x2210,0x2210,0x2210,0x1de0,0x0,},
	/* : */ {0x0,0x1e00,0x2110,0x2110,0x2110,0x2120,0x1fc0,0x0,},
	/* ; */ {0x0,0x0,0x0,0x630,0x0,0x0,0x0,0x0,},
	/* < */ {0x0,0x0,0x8,0x630,0x0,0x0,0x0,0x0,},
	/* = */ {0x0,0x100,0x280,0x440,0x820,0x1010,0x0,0x0,},
	/* > */ {0x0,0x480,0x480,0x480,0x480,0x480,0x480,0x0,},
	/* ? */ {0x0,0x1010,0x820,0x440,0x280,0x100,0x0,0x0,},
	/* @ */ {0x0,0x1c00,0x2000,0x2000,0x21b0,0x2200,0x1c00,0x0,},
	/* A */ {0x1fe0,0x2010,0x2790,0x2850,0x2850,0x2890,0x1fd0,0x0,},
	/* B */ {0x0,0x1ff0,0x2100,0x2100,0x2100,0x2100,0x1ff0,0x0,},
	/* C */ {0x0,0x3ff0,0x2210,0x2210,0x2210,0x2210,0x1de0,0x0,},
	/* D */ {0x0,0x1fe0,0x2010,0x2010,0x2010,0x2010,0x1860,0x0,},
	/* E */ {0x0,0x3ff0,0x2010,0x2010,0x2010,0x1020,0xfc0,0x0,},
	/* F */ {0x0,0x3ff0,0x2210,0x2210,0x2210,0x2010,0x2010,0x0,},
	/* G */ {0x0,0x3ff0,0x2200,0x2200,0x2200,0x2000,0x2000,0x0,},
	/* H */ {0x0,0x1fe0,0x2010,0x2010,0x2110,0x2110,0x19e0,0x0,},
	/* I */ {0x0,0x3ff0,0x200,0x200,0x200,0x200,0x3ff0,0x0,},
	/* J */ {0x0,0x0,0x2010,0x3ff0,0x2010,0x0,0x0,0x0,},
	/* K */ {0x0,0x60,0x10,0x10,0x2010,0x3fe0,0x2000,0x0,},
	/* L */ {0x0,0x3ff0,0x300,0x480,0x840,0x1020,0x2010,0x0,},
	/* M */ {0x0,0x3ff0,0x10,0x10,0x10,0x10,0x10,0x0,},
	/* N */ {0x3ff0,0x1000,0x800,0x600,0x800,0x1000,0x3ff0,0x0,},
	/* O */ {0x0,0x3ff0,0x400,0x200,0x100,0x80,0x3ff0,0x0,},
	/* P */ {0x0,0x1fe0,0x2010,0x2010,0x2010,0x2010,0x1fe0,0x0,},
	/* Q */ {0x0,0x3ff0,0x2100,0x2100,0x2100,0x2100,0x1e00,0x0,},
	/* R */ {0x0,0x1fe0,0x2010,0x2010,0x2030,0x2010,0x1fe8,0x0,},
	/* S */ {0x0,0x3ff0,0x2100,0x2180,0x2140,0x2120,0x1e10,0x0,},
	/* T */ {0x0,0x1c60,0x2210,0x2210,0x2210,0x2210,0x11e0,0x0,},
	/* U */ {0x2000,0x2000,0x2000,0x3ff0,0x2000,0x2000,0x2000,0x0,},
	/* V */ {0x0,0x3fe0,0x10,0x10,0x10,0x10,0x3fe0,0x0,},
	/* W */ {0x0,0x3e00,0x1c0,0x30,0x30,0x1c0,0x3e00,0x0,},
	/* X */ {0x3ff0,0x20,0x40,0x180,0x40,0x20,0x3ff0,0x0,},
	/* Y */ {0x0,0x3030,0xcc0,0x300,0x300,0xcc0,0x3030,0x0,},
	/* Z */ {0x3000,0xc00,0x200,0x1f0,0x200,0xc00,0x3000,0x0,},
	/* [ */ {0x0,0x2070,0x2090,0x2110,0x2210,0x2410,0x3810,0x0,},
	/* \ */ {0x0,0x0,0x3ff0,0x2010,0x2010,0x0,0x0,0x0,},
	/* ] */ {0x0,0x3000,0xc00,0x300,0xc0,0x30,0x0,0x0,},
	/* ^ */ {0x0,0x0,0x2010,0x2010,0x3ff0,0x0,0x0,0x0,},
	/* _ */ {0x0,0x1000,0x2000,0x4000,0x2000,0x1000,0x0,0x0,},
	/* ` */ {0x0,0x4,0x4,0x4,0x4,0x4,0x4,0x0,},
	/* a */ {0x0,0x0,0x0,0x8000,0x4000,0x0,0x0,0x0,},
	/* b */ {0x0,0xe0,0x510,0x510,0x510,0x510,0x3f0,0x0,},
	/* c */ {0x0,0x3ff0,0x410,0x410,0x410,0x410,0x3e0,0x0,},
	/* d */ {0x0,0x3e0,0x410,0x410,0x410,0x410,0x220,0x0,},
	/* e */ {0x0,0x3e0,0x410,0x410,0x410,0x410,0x3ff0,0x0,},
	/* f */ {0x0,0x3e0,0x490,0x490,0x490,0x490,0x380,0x0,},
	/* g */ {0x0,0x400,0x400,0x1ff0,0x2400,0x2400,0x2000,0x0,},
	/* h */ {0x0,0x3e0,0x412,0x412,0x412,0x412,0x7fc,0x0,},
	/* i */ {0x0,0x3ff0,0x400,0x400,0x400,0x400,0x3f0,0x0,},
	/* j */ {0x0,0x0,0x410,0x37f0,0x10,0x0,0x0,0x0,},
	/* k */ {0x0,0xc,0x2,0x2,0x402,0x37fc,0x0,0x0,},
	/* l */ {0x0,0x3ff0,0x80,0x80,0x140,0x220,0x410,0x0,},
	/* m */ {0x0,0x0,0x2010,0x3ff0,0x10,0x0,0x0,0x0,},
	/* n */ {0x7f0,0x400,0x400,0x7f0,0x400,0x400,0x3f0,0x0,},
	/* o */ {0x0,0x7f0,0x400,0x400,0x400,0x400,0x3f0,0x0,},
	/* p */ {0x0,0x3e0,0x410,0x410,0x410,0x410,0x3e0,0x0,},
	/* q */ {0x0,0x7fe,0x410,0x410,0x410,0x410,0x3e0,0x0,},
	/* r */ {0x0,0x3e0,0x410,0x410,0x410,0x410,0x7fe,0x0,},
	/* s */ {0x0,0x7f0,0x200,0x400,0x400,0x400,0x400,0x0,},
	/* t */ {0x0,0x310,0x490,0x490,0x490,0x490,0x460,0x0,},
	/* u */ {0x0,0x400,0x400,0x3fe0,0x410,0x410,0x10,0x0,},
	/* v */ {0x0,0x7e0,0x10,0x10,0x10,0x10,0x7f0,0x0,},
	/* w */ {0x0,0x700,0xc0,0x30,0x30,0xc0,0x700,0x0,},
	/* x */ {0x7e0,0x10,0x10,0x1f0,0x10,0x10,0x7e0,0x0,},
	/* y */ {0x0,0x630,0x140,0x80,0x80,0x140,0x630,0x0,},
	/* z */ {0x0,0x7e0,0x12,0x12,0x12,0x12,0x7fc,0x0,},
	/* { */ {0x0,0x430,0x450,0x490,0x510,0x610,0x410,0x0,},
	/* | */ {0x0,0x0,0x200,0x1de0,0x2010,0x2010,0x0,0x0,},
	/* } */ {0x0,0x0,0x0,0x3ff0,0x0,0x0,0x0,0x0,},
	/* ~ */ {0x0,0x0,0x2010,0x2010,0x1de0,0x200,0x0,0x0,},
	/*   */ {0x180,0x200,0x200,0x100,0x80,0x80,0x300,0x0,},
	/* â‚¬ */ {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,},
	/* ? */ {0x280,0x7c0,0xaa0,0x1290,0x1290,0x1010,0x820,0x0,},
	/* ? */ {0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,0xffff,},
	/* ? */ {0xaaaa,0x5555,0xaaaa,0x5555,0xaaaa,0x5555,0xaaaa,0x5555,},
	/* ? */ {0xaaaa,0x0,0x5555,0x0,0xaaaa,0x0,0x5555,0x0,},
	/* ? */ {0xffff,0xaaaa,0xffff,0x5555,0xffff,0xaaaa,0xffff,0x5555,},
	/* ? */ {0x100,0x100,0x100,0x100,0x100,0x100,0x100,0x100,},
	/* ? */ {0x0,0x0,0x0,0x1ff,0x100,0x100,0x100,0x100,},
	/* ? */ {0x100,0x100,0x100,0x1ff,0x0,0x0,0x0,0x0,},
	/* ? */ {0x0,0x0,0x0,0xff00,0x100,0x100,0x100,0x100,},
	/* ? */ {0x100,0x100,0x100,0xff00,0x0,0x0,0x0,0x0,},
	/* ? */ {0x0,0x0,0xff80,0x80,0xfe80,0x280,0x280,0x280,},
	/* ? */ {0x0,0x0,0x3ff,0x200,0x2ff,0x280,0x280,0x280,},
	/* ? */ {0x280,0x280,0xfe80,0x80,0xff80,0x0,0x0,0x0,},
	/* ? */ {0x280,0x280,0x2ff,0x200,0x3ff,0x0,0x0,0x0,},
	/* ? */ {0x0,0x0,0x0,0xffff,0x0,0x0,0x0,0x0,},
	/* ? */ {0x280,0x280,0x280,0x280,0x280,0x280,0x280,0x280,},
	/* ? */ {0x0,0x0,0xffff,0x0,0xffff,0x0,0x0,0x0,},
};

/* == End Terminus Font == */

static void display_draw(struct display_ctx* ctx, unsigned char x,
				unsigned char y, unsigned char font,
				char* text, unsigned char length);
static unsigned char remap(char in, unsigned char font);
static void writezero(unsigned addr, unsigned n);
static void writeaddr(unsigned addr);

void display_init_ctx(struct display_ctx* ctx)
{
	unsigned char i;
	unsigned char initialization_sequence[][2] = {
		/* mode / initialization */
		{ 1, GP9002_DISPLAY },
		{ 0, GP9002_DISPLAY_MONOCHROME },
		/* brightness */
		{ 1, GP9002_BRIGHT },
		{ 0, DISPLAY_BRIGHTNESS_PERC_100 },
		/* 2nd screen starts at 0x400 */
		{ 1, GP9002_LOWERADDR2 },
		{ 0, 0x00 },
		{ 1, GP9002_HIGHERADDR2 },
		{ 0, 0x04 },
		/* clear and show vscreen 0 */
		{ 1, GP9002_CLEARSCREEN },
		{ 1, GP9002_DISPLAY1ON },
	};

	ctx->vscreen = 0;
	ctx->brightness = DISPLAY_BRIGHTNESS_PERC_100;

	for(i = 0; i < (sizeof(initialization_sequence) / (2 * sizeof(char)));
									i++)
		ll_out_display(initialization_sequence[i][0],
						initialization_sequence[i][1]);
}

void display_update(struct display_ctx* ctx, struct display_shared* data)
{
	unsigned char i;
	char old_vscreen =  ctx->vscreen;
	ctx->vscreen     = !ctx->vscreen;

	/* write to new screen */
	for(i = 0; i < data->num_entries; i++)
		display_draw(ctx, data->entry_x[i], data->entry_y[i],
			data->entry_font[i],
			data->entry_text + data->entry_offsets[i],
			data->entry_lengths[i]);

	/* update brightness if necessary */
	if(data->set_brightness != ctx->brightness) {
		ctx->brightness = data->set_brightness;
		ll_out_display(1, GP9002_BRIGHT);
		ll_out_display(0, ctx->brightness);
	}

	/* display new screen */
	switch(ctx->vscreen) {
	case 0: ll_out_display(1, GP9002_DISPLAY1ON); break;
	case 1: ll_out_display(1, GP9002_DISPLAY2ON); break;
	}

	/* clear old screen */
	writezero(old_vscreen << 10, 0x400);
}

static void display_draw(struct display_ctx* ctx, unsigned char x,
				unsigned char y, unsigned char font,
				char* text, unsigned char length)
{
	/* for now we blindly assume y % 8 = 0! */
	unsigned addr = x * 8 + y / 8;
	unsigned char i;
	unsigned char rx;

	unsigned char letter_width;
	unsigned      ds;
	long unsigned dl;

	switch(font) {
	case DISPLAY_FONT_NORMAL: letter_width =  8; break;
	case DISPLAY_FONT_LARGE:  letter_width = 16; break;
	default:                        /* error */ return;
	}

	for(i = 0; i < length; i++) {
		unsigned char letter = remap(text[i], font);
		for(rx = 0; rx < letter_width; rx++) {
			writeaddr(addr);
			switch(font) {
			case DISPLAY_FONT_NORMAL:
				ds = FONT_SMALL[letter][rx];
				ll_out_display(0, (ds & 0xff00) >> 8);
				ll_out_display(0, (ds & 0x00ff) >> 0);
				break;
			case DISPLAY_FONT_LARGE:
				dl = FONT_LARGE[letter][rx];
				ll_out_display(0, (dl & 0xff000000) >> 24);
				ll_out_display(0, (dl & 0x00ff0000) >> 16);
				ll_out_display(0, (dl & 0x0000ff00) >>  8);
				ll_out_display(0, (dl & 0x000000ff) >>  0);
				break;
			/* default: */
				/* error */
			}
			addr += 8;
		}
	}
}

static unsigned char remap(char in, unsigned char font)
{
	switch(font) {
	case DISPLAY_FONT_NORMAL:
		return in - '!';
	case DISPLAY_FONT_LARGE:
		if(in >= '-' && in <= ':') {
			return in - '-';
		} else {
			switch(in) {
			case '(': return 0 + (':' - '-');
			case '!': return 1 + (':' - '-');
			case ')': return 2 + (':' - '-');
			case '*': return 3 + (':' - '-');
			case '#': return 4 + (':' - '-');
			case ' ': return 5 + (':' - '-');
			default:  return 1 + (':' - '-'); /* error */
			}
		}
	default:
		/* unknown */
		return 0;
	}
}

static void writezero(unsigned addr, unsigned n)
{
	unsigned i;
	writeaddr(addr);
	for(i = 0; i < n; i++)
		ll_out_display(0, 0x00);
}

static void writeaddr(unsigned addr)
{
	ll_out_display(1, GP9002_ADDRL);
	ll_out_display(0, addr & 0xff);
	ll_out_display(1, GP9002_ADDRH);
	ll_out_display(0, (addr & 0xf00) >> 8);
	ll_out_display(1, GP9002_DATAWRITE);
}
